# Multi-School Result Management System (Multi-SRMS)
## Database Setup Instructions

This document provides detailed instructions for configuring the PostgreSQL database for both local development and production deployment scenarios.

---

## Local Development Setup

### Prerequisites
1. Install PostgreSQL (version 12 or higher)
2. Ensure PostgreSQL service is running on localhost:5432
3. Node.js and npm should be installed

### Environment Configuration

#### 1. Configure Environment Variables
Create or update the `.env` file in the project root with the following settings:

```env
# Database Configuration
DB_HOST=localhost
DB_PORT=5432
DB_NAME=multi_srms_new
DB_USER=postgres
DB_PASS=  # Leave empty for local development
DB_SSL=false

# API Configuration
PORT=3002
VITE_API_URL=http://localhost:3002
```

**Important Notes for Local Development:**
- The `DB_PASS` should be left empty (`DB_PASS=`) as per project configuration
- The default database name is `multi_srms_new`
- The application runs on port 3002 (not 3001) to avoid conflicts

#### 2. Initialize the Database
Run the database initialization script to set up the database schema:

```bash
npm run init:db
```

This command will:
- Create the database if it doesn't exist
- Initialize all required tables and relationships
- Add default data (admin user, academic years, application settings)

#### 3. Test Database Connection
Verify the database connection with:

```bash
npm run test:db
```

Or alternatively:

```bash
npx tsx scripts/test-db-connection.ts
```

#### 4. Start the Application
After database setup, start the backend server:

```bash
npm run dev:backend
```

---

## Production Deployment Setup

### Prerequisites
1. PostgreSQL database server (can be cloud-based like AWS RDS, Google Cloud SQL, etc.)
2. Network access to the database server
3. Proper security groups/firewall rules configured

### Environment Configuration

#### 1. Configure Production Environment Variables
Create or update the `.env.production` file with production-specific settings:

```env
# Production Database Configuration
DB_HOST=your-production-db-host  # e.g., your-instance.region.rds.amazonaws.com
DB_PORT=5432
DB_NAME=multi_srms_prod
DB_USER=your_production_user
DB_PASS=your_production_password  # Set a strong password
DB_SSL=true  # Enable SSL for secure connections

# Production Server Configuration
PORT=3002
VITE_API_URL=https://yourdomain.com/api

# Production Email Configuration
EMAIL_SERVICE=your-email-service  # e.g., gmail, sendgrid
EMAIL_USER=your_production_email@yourdomain.com
EMAIL_PASS=your_app_password

# JWT Secret for production environment
JWT_SECRET=your_strong_production_secret_key_here

# Frontend URL for production environment
FRONTEND_URL=https://yourdomain.com
```

#### 2. Manual Database Setup (if not using init script)
If you cannot use the automated initialization script, manually create the database and run the schema:

1. Connect to your PostgreSQL instance:
```bash
psql -h your-production-db-host -p 5432 -U your_production_user -d postgres
```

2. Create the database:
```sql
CREATE DATABASE multi_srms_prod;
```

3. Connect to the new database and run the schema from `init-scripts/01-init-schema.sql`:
```bash
psql -h your-production-db-host -p 5432 -U your_production_user -d multi_srms_prod -f init-scripts/01-init-schema.sql
```

#### 3. Configure Connection Pool Settings
In production, adjust the connection pool settings in `config/db.ts` if needed:

```typescript
const pool = new Pool({
  host: process.env.DB_HOST || 'localhost',
  port: parseInt(process.env.DB_PORT || '5432'),
  user: process.env.DB_USER || 'postgres',
  password: process.env.DB_PASS || '',
  database: process.env.DB_NAME || 'multi_srms_new',
  max: 20, // Adjust based on your server capacity
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
  ssl: process.env.DB_SSL === 'true' ? { rejectUnauthorized: false } : false
});
```

#### 4. Security Considerations
- Never commit `.env.production` to version control
- Use strong passwords and rotate them regularly
- Enable SSL/TLS encryption for database connections
- Restrict database user permissions to only what's necessary
- Use environment-specific JWT secrets
- Regularly backup your production database

---

## Key Differences Between Local and Production Setup

| Aspect | Local Development | Production |
|--------|------------------|------------|
| Database Host | localhost | Remote server/IP |
| Database Password | Empty | Strong password |
| SSL | Disabled | Enabled |
| Database Name | multi_srms_new | multi_srms_prod |
| Connection Pool Size | Default (20) | Optimized for traffic |
| Security | Minimal | Comprehensive |
| Backups | Manual/local | Automated/regular |

---

## Troubleshooting Common Issues

### 1. Connection Refused
- Ensure PostgreSQL service is running
- Check firewall settings
- Verify host and port in environment variables

### 2. Authentication Failed
- Confirm username and password
- Check if the database user exists
- Ensure the user has proper permissions

### 3. Database Does Not Exist
- Run the initialization script: `npm run init:db`
- Or manually create the database

### 4. SSL Connection Errors
- Ensure `DB_SSL=true` in production environment
- Check SSL certificate configuration on the database server

---

## Useful Commands

| Command | Purpose |
|---------|---------|
| `npm run init:db` | Initialize database schema |
| `npm run test:db` | Test database connection |
| `npx tsx scripts/test-db-connection.ts` | Alternative database test |
| `npm run dev:backend` | Start backend server |

For any issues or questions regarding database setup, please refer to the project documentation or contact the development team.