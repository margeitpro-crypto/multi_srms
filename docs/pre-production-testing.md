# Pre-Production Testing with Anonymized Data

This document explains how to prepare and use anonymized data for thorough testing before deployment in a near-real environment that closely simulates production conditions.

## Overview

The pre-production testing process involves:
1. Anonymizing real production data to protect privacy
2. Importing the anonymized data into a test environment
3. Running comprehensive tests to validate functionality
4. Verifying data integrity and security measures

## Scripts

### 1. Data Anonymization (`anonymize-data.ts`)

This script extracts real data from the database and anonymizes sensitive information:

```bash
npm run anonymize:data
```

**What it does:**
- Extracts all schools, students, and subjects from the database
- Anonymizes sensitive fields:
  - School names, IEMIS codes, municipalities
  - Student names, parent names, mobile numbers, emails
  - Teacher names and contact information
- Preserves non-sensitive data (subjects, grades, etc.)
- Generates both JSON files and SQL insert statements
- Saves output to `data/anonymized/` directory

**Files generated:**
- `schools.json` - Anonymized school data in JSON format
- `students.json` - Anonymized student data in JSON format
- `subjects.json` - Subject data (unchanged)
- `anonymized-data.sql` - SQL insert statements for direct database import

### 2. Data Import (`import-anonymized-data.ts`)

This script imports the anonymized data into a test database:

```bash
npm run import:anonymized-data
```

**What it does:**
- Reads the SQL file generated by the anonymization script
- Executes SQL statements to populate the test database
- Clears existing data before importing new anonymized data

### 3. Testing (`test-with-anonymized-data.ts`)

This script runs comprehensive tests with the anonymized data:

```bash
npm run test:anonymized-data
```

**What it tests:**
- Database connectivity and data retrieval
- Data anonymization verification
- CRUD operations (Create, Read, Update, Delete)
- Subject assignments and marks entry
- Data integrity checks
- Date format validation

## Workflow

### Step 1: Anonymize Production Data

Run the anonymization script to extract and anonymize real data:

```bash
npm run anonymize:data
```

This will create anonymized copies of your production data in the `data/anonymized/` directory.

### Step 2: Set Up Test Environment

1. Create a separate test database (recommended)
2. Update your `.env` file to point to the test database
3. Initialize the test database schema:

```bash
npm run init:db
```

### Step 3: Import Anonymized Data

Import the anonymized data into your test environment:

```bash
npm run import:anonymized-data
```

### Step 4: Run Comprehensive Tests

Execute the test suite to verify everything works correctly:

```bash
npm run test:anonymized-data
```

## Data Anonymization Process

### Schools
- School names are replaced with generic test names
- IEMIS codes are randomized
- Municipalities are replaced with test locations
- Staff names are replaced with generated names
- Contact information is randomized
- Email addresses are replaced with test emails

### Students
- Student names are replaced with generated names
- Parent names are replaced with generated names
- Mobile numbers are randomized
- Email addresses are replaced with test emails
- Dates of birth are preserved but other personal information is anonymized

### Subjects and Other Non-Sensitive Data
- Subject names and codes are preserved as they don't contain personal information
- Grade information is preserved
- Academic year data is preserved

## Security Considerations

1. **Data Protection**: All personally identifiable information (PII) is removed or replaced
2. **Access Control**: Ensure test environments have appropriate access controls
3. **Data Retention**: Regularly clean up test data to minimize exposure
4. **Environment Isolation**: Keep test environments separate from production

## Troubleshooting

### No Data Found
If the anonymization script reports no data found:
- Verify database connection settings in `.env`
- Ensure the database contains data
- Check that the database service is running

### Import Failures
If the import script fails:
- Check that the SQL file exists in `data/anonymized/`
- Verify database connectivity
- Ensure the database user has appropriate permissions

### Test Failures
If tests fail:
- Check the error messages for specific issues
- Verify that all required data was imported
- Ensure the database schema is up to date

## Best Practices

1. **Regular Updates**: Regularly update anonymized data to reflect schema changes
2. **Version Control**: Keep anonymized data files in version control
3. **Automated Testing**: Integrate these scripts into your CI/CD pipeline
4. **Performance Testing**: Use anonymized data for performance and load testing
5. **Security Testing**: Validate that no PII leaks through the application

## Example Usage

```bash
# 1. Anonymize production data
npm run anonymize:data

# 2. Set up test database (in .env)
# DB_NAME=multi_srms_test

# 3. Initialize test database
npm run init:db

# 4. Import anonymized data
npm run import:anonymized-data

# 5. Run tests
npm run test:anonymized-data
```

This process ensures that you can thoroughly test your application with realistic data while maintaining privacy and security.